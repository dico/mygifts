<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <title>Logger ut…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html,body{height:100%;margin:0}body{display:grid;place-items:center;font-family:system-ui,sans-serif}
    .box{color:#444;text-align:center}.spinner{width:44px;height:44px;border:4px solid #ddd;border-top-color:#888;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="box">
    <div class="spinner"></div>
    <div>Logger deg ut…</div>
  </div>

<script>
(async () => {
  // 1) Les konfig for å hente Keycloak-base og vår redirect (login/)
  let cfg;
  try {
    const res = await fetch('/api/public/config', { cache: 'no-store' });
    const json = await res.json();
    if (json?.status !== 'success') throw new Error('config');
    cfg = json.data || {};
  } catch {
    // Fallback: rydd lokalt og gå til /login
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    localStorage.removeItem('id_token');
    sessionStorage.removeItem('relogin_once');
    location.replace('/login/');
    return;
  }

  const KC_BASE       = (cfg.keycloak_base || '').replace(/\/+$/, '');
  const REDIRECT_URI  = cfg.redirect_uri || (location.origin + '/login/');
  const idToken       = localStorage.getItem('id_token');

  // 2) Rydd lokale tokens uansett
  localStorage.removeItem('access_token');
  localStorage.removeItem('refresh_token');
  localStorage.removeItem('id_token');
  sessionStorage.removeItem('relogin_once');

  // 3) Bygg RP-initiated logout URL
  //    post_logout_redirect_uri MÅ være registrert i Keycloak-klienten.
  const url = new URL(KC_BASE + '/protocol/openid-connect/logout');
  const params = new URLSearchParams({
    post_logout_redirect_uri: REDIRECT_URI
  });
  // id_token_hint gjør at Keycloak kan logge ut uten confirm
  if (idToken) params.set('id_token_hint', idToken);
  url.search = params.toString();

  // 4) Send til Keycloak logout (RP-initiated). Om KC returnerer 400 pga config,
  //    havner du på KC-feilside; trykk back vil i praksis være logget ut lokalt.
  location.replace(url.toString());
})();
</script>
</body>
</html>
