<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <title>MyGifts • Onboarding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <style> body { background: #f7f7fb; } </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="javascript:void(0)">🎁 MyGifts</a>
    </div>
  </nav>

  <main class="container py-5" style="max-width:760px">
    <div id="errorBox" class="alert alert-danger d-none" role="alert"></div>

    <div class="card shadow-sm" id="card">
      <div class="card-body">
        <h4 class="mb-2">Kom i gang</h4>
        <p class="text-muted mb-4">Opprett husholdningen din. Du blir automatisk <em>parent</em> i husholdningen.</p>

        <form id="onboardingForm"
              action="/api/households"
              method="post"
              data-send="json">
          <div class="mb-3">
            <label for="hhName" class="form-label">Navn på husholdning</label>
            <input id="hhName" name="name" type="text" class="form-control" placeholder="F.eks. Familien Andresen" required>
            <div class="form-text">Du kan invitere familie/venner etterpå.</div>
          </div>

          <button type="submit" class="btn btn-primary">Opprett husholdning</button>
        </form>
      </div>
    </div>

    <div class="text-center text-muted small mt-4" id="meInfo">Laster…</div>
  </main>

  <script type="module">
    import { api } from './assets/js/Remote.js';
    import FormHandler from './assets/js/FormHandler.js';

    const $ = (sel) => document.querySelector(sel);
    const $name   = $('#hhName');
    const $error  = $('#errorBox');
    const $meInfo = $('#meInfo');
    const $card   = $('#card');

    const showError = (msg, status) => {
      $error.textContent = status ? `${msg} (HTTP ${status})` : msg;
      $error.classList.remove('d-none');
    };
    const hideError = () => $error.classList.add('d-none');

    async function init() {
      try {
        const me = await api('/api/auth/me');

        // Ny logikk: redirect hvis aktiv household finnes
        const hasActive = !!me?.data?.active_household_id;
        if (hasActive) {
          // Allerede klar til bruk → inn i appen
          location.replace('/app/');
          return;
        }

        // Hvis ingen aktiv household: vis skjema
        // (valgfritt: også redirecte hvis needs_setup === false men aktiv mangler,
        // men her lar vi brukeren opprette en ny aktiv.)
        const email = me?.data?.email || '';
        if (email && !$name.value) {
          const nick = email.split('@')[0].replace(/[._]/g, ' ');
          $name.value = `Familien ${nick.charAt(0).toUpperCase()}${nick.slice(1)}`;
        }
        $meInfo.textContent = email ? `Innlogget som ${email}` : '';
        $card.style.removeProperty('display'); // sørg for at kortet er synlig
      } catch (e) {
        // Feil ved /auth/me
        $meInfo.textContent = '';
        showError(e?.message || 'Kunne ikke hente brukerinfo', e?.status);
        if ((e?.status === 401) || !localStorage.getItem('access_token')) {
          setTimeout(() => location.replace('/login/'), 800);
        }
      }
    }

    // Bind form – redirect ved suksess
    new FormHandler(document.getElementById('onboardingForm'), {
      resetOnSuccess: false,
      onSuccess: (res) => {
        if (res?.status === 'success') {
          // createHousehold setter aktiv household → inn i appen
          location.replace('/app/');
        }
      },
      onError: (err) => {
        showError(err?.message || 'Kunne ikke opprette husholdning', err?.status);
      }
    });

    // Skjul kort til vi vet om vi skal vise det
    document.addEventListener('DOMContentLoaded', () => {
      $card.style.display = 'none';
      init().finally(() => {
        // Hvis init ikke redirectet eller kastet, sørg for at kort vises
        if ($card.style.display === 'none') $card.style.removeProperty('display');
      });
    });
  </script>
</body>
</html>
